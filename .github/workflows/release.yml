name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x86_64
          - os: macos-latest
            target: darwin-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout hpm
        uses: actions/checkout@v4

      - name: Checkout hemlock
        uses: actions/checkout@v4
        with:
          repository: hemlang/hemlock
          path: hemlock

      - name: Build hemlock
        run: |
          cd hemlock
          make
          ./hemlock --version

      - name: Verify hemlock build
        run: hemlock/hemlock --version

      - name: Run tests
        run: |
          export PATH="$PWD/hemlock:$PATH"
          make test

      - name: Build static hpm binary
        run: |
          export PATH="$PWD/hemlock:$PATH"
          # Use hemlockc to compile hpm as a static binary
          hemlockc --static src/main.hml -o hpm
          chmod +x hpm
          # Verify the binary works
          ./hpm --version

      - name: Create release package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PACKAGE_NAME="hpm-${VERSION}-${{ matrix.target }}"
          mkdir -p "${PACKAGE_NAME}/bin"

          # Copy the static hpm binary
          cp hpm "${PACKAGE_NAME}/bin/"

          # Copy documentation
          cp LICENSE "${PACKAGE_NAME}/" 2>/dev/null || true
          cp README.md "${PACKAGE_NAME}/" 2>/dev/null || true

          # Create install script
          cat > "${PACKAGE_NAME}/install.sh" << 'EOF'
#!/bin/sh
set -e

PREFIX="${1:-/usr/local}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "Installing hpm to ${PREFIX}..."

# Create directories
mkdir -p "${PREFIX}/bin"

# Copy hpm binary
cp "${SCRIPT_DIR}/bin/hpm" "${PREFIX}/bin/"
chmod +x "${PREFIX}/bin/hpm"

echo "Installation complete!"
echo "Make sure ${PREFIX}/bin is in your PATH"
EOF
          chmod +x "${PACKAGE_NAME}/install.sh"

          # Create tarball
          tar -czvf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hpm-${{ matrix.target }}
          path: hpm-*-${{ matrix.target }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
